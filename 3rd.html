<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EcoSphere - Interactive Dashboard</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;700;900&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#17cf17",
            "background-light": "#f6f8f6",
            "surface-light": "#ffffff",
            "border-light": "#d9e7d9",
            "subtle-light": "#4e974e"
          },
          fontFamily: { display: ["Public Sans", "sans-serif"] },
        },
      },
    };
  </script>

  <style>
    #map {
      height: 420px;
      width: 100%;
      border-radius: 0.75rem;
    }
  </style>
</head>
<body class="font-display bg-background-light text-text-light">

  <div class="max-w-7xl mx-auto p-6">
    <h1 class="text-3xl font-extrabold mb-4 text-primary">🌿 EcoSphere Community Dashboard</h1>

    <!-- Map Search and Interaction -->
    <div class="mb-6">
      <div class="flex gap-3 mb-3">
        <input type="text" id="location-input" placeholder="Search location..." 
               class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary" />
        <button id="search-btn" class="bg-primary text-white px-4 py-2 rounded-lg">Search</button>
      </div>
      <div id="map" class="border border-light"></div>
      <p class="text-sm mt-2 text-subtle-light">Click on the map or search a location to view area blogs/issues.</p>
    </div>

    <!-- Nearby Blogs -->
    <div id="nearby-section" class="hidden bg-white border rounded-xl p-4 mt-4 shadow-sm">
      <h2 class="text-xl font-bold text-primary mb-2">Nearby Blogs & Issues</h2>
      <ul id="nearby-list" class="space-y-2"></ul>
    </div>

    <!-- Comments Section -->
    <div class="bg-white border rounded-xl p-4 mt-6 shadow-sm">
      <h3 class="text-lg font-bold text-primary mb-3">💬 Community Comments</h3>
      <div id="comments-container" class="space-y-3 mb-3"></div>

      <div class="flex gap-2">
        <input type="text" id="comment-input" placeholder="Write a comment..." class="flex-1 border px-3 py-2 rounded-lg" />
        <button id="add-comment" class="bg-primary text-white px-4 py-2 rounded-lg">Post</button>
      </div>
    </div>
  </div>

  <script>
    /* -----------------------------------
       🗺️ INTERACTIVE MAP SETUP
    ----------------------------------- */
    const map = L.map('map').setView([28.6139, 77.2090], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    let marker;
    map.on('click', (e) => {
      const { lat, lng } = e.latlng;
      if (marker) marker.remove();
      marker = L.marker([lat, lng]).addTo(map)
        .bindPopup(`📍 Selected Location<br>Lat: ${lat.toFixed(3)}, Lng: ${lng.toFixed(3)}`)
        .openPopup();
      loadNearbyBlogs(lat, lng);
    });

    document.getElementById('search-btn').addEventListener('click', async () => {
      const query = document.getElementById('location-input').value.trim();
      if (!query) return;
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
      const data = await res.json();
      if (data.length) {
        const { lat, lon } = data[0];
        map.setView([lat, lon], 13);
        if (marker) marker.remove();
        marker = L.marker([lat, lon]).addTo(map)
          .bindPopup(`📍 ${query}`).openPopup();
        loadNearbyBlogs(lat, lon);
      }
    });

    /* -----------------------------------
       📰 LOAD NEARBY BLOGS
    ----------------------------------- */
    function loadNearbyBlogs(lat, lng) {
      const blogs = [
        { title: "🌱 Tree Plantation Drive", desc: "Join us this weekend near City Park!", dist: "1.2 km" },
        { title: "🚯 Plastic Waste Cleanup", desc: "Volunteers needed for river cleanup.", dist: "2.5 km" },
        { title: "🌍 Air Quality Report", desc: "Recent data shows PM2.5 improvement.", dist: "3.1 km" }
      ];

      const list = document.getElementById("nearby-list");
      list.innerHTML = blogs.map(b => `
        <li class="border p-3 rounded-lg hover:bg-primary/10 transition">
          <h4 class="font-semibold">${b.title}</h4>
          <p class="text-sm text-gray-600">${b.desc}</p>
          <p class="text-xs text-gray-500 mt-1">📏 Distance: ${b.dist}</p>
        </li>
      `).join("");

      document.getElementById("nearby-section").classList.remove("hidden");
    }

    /* -----------------------------------
       💬 INTERACTIVE COMMENT SYSTEM
    ----------------------------------- */
    const commentInput = document.getElementById("comment-input");
    const addCommentBtn = document.getElementById("add-comment");
    const commentsContainer = document.getElementById("comments-container");

    let comments = JSON.parse(localStorage.getItem("eco_comments_v2")) || [];

    function saveComments() {
      localStorage.setItem("eco_comments_v2", JSON.stringify(comments));
    }

    function renderComments() {
      commentsContainer.innerHTML = comments.map((c, i) => `
        <div class="border p-3 rounded-lg">
          <p class="text-sm">${c.text}</p>
          <div class="flex items-center gap-3 mt-2 text-sm">
            <button onclick="likeComment(${i})" class="text-primary">❤️ ${c.likes}</button>
            <button onclick="replyToComment(${i})" class="text-blue-500">💬 Reply</button>
          </div>
          ${c.replies.map((r, ri) => `
            <div class="ml-4 mt-2 p-2 border-l-2 border-primary text-sm">
              ↳ ${r}
            </div>
          `).join("")}
        </div>
      `).join("");
    }

    addCommentBtn.addEventListener("click", () => {
      const text = commentInput.value.trim();
      if (!text) return;
      comments.push({ text, likes: 0, replies: [] });
      saveComments();
      commentInput.value = "";
      renderComments();
    });

    window.likeComment = (i) => {
      comments[i].likes++;
      saveComments();
      renderComments();
    };

    window.replyToComment = (i) => {
      const reply = prompt("Write your reply:");
      if (reply) {
        comments[i].replies.push(reply);
        saveComments();
        renderComments();
      }
    };

    renderComments();
  </script>

</body>
</html>
